<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">  <!-- ← This is crucial! -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Chat room of Soham</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 25px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: #10b981;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .main-content {
      display: flex;
      height: 600px;
    }

    .sidebar {
      width: 280px;
      background: #f8fafc;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
    }

    .user-section {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
    }

    .user-input-group {
      margin-bottom: 15px;
    }

    .user-input-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .username-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.2s;
      background: white;
    }

    .username-input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .username-status {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      display: none;
    }

    .username-status.valid {
      background: #dcfce7;
      color: #166534;
      display: block;
    }

    .chat-controls {
      padding: 20px;
      flex-grow: 1;
    }

    .control-button {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #e2e8f0;
    }

    .control-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
    }

    .message {
      margin-bottom: 16px;
      animation: slideIn 0.3s ease-out;
    }

    .message-bubble {
      background: white;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #4f46e5;
      position: relative;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .message-username {
      font-weight: 700;
      color: #4f46e5;
      font-size: 0.9rem;
    }

    .message-time {
      font-size: 0.75rem;
      color: #64748b;
    }

    .message-content {
      color: #374151;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message-file {
      margin-top: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    .message-file img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .message-file img:hover {
      transform: scale(1.02);
    }

    .file-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      background: #eef2ff;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .file-link:hover {
      background: #ddd6fe;
      transform: translateY(-1px);
    }

    .input-area {
      padding: 20px;
      background: white;
      border-top: 1px solid #e2e8f0;
    }

    .message-input-container {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .message-input {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      font-size: 1rem;
      transition: all 0.2s;
      background: #f8fafc;
    }

    .message-input:focus {
      outline: none;
      border-color: #4f46e5;
      background: white;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .send-button {
      padding: 14px 24px;
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 100px;
    }

    .send-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
    }

    .file-upload-area {
      padding: 16px;
      background: #f8fafc;
      border-radius: 16px;
      border: 2px dashed #cbd5e1;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
    }

    .file-upload-area:hover {
      border-color: #4f46e5;
      background: #eef2ff;
    }

    .file-upload-area.dragover {
      border-color: #4f46e5;
      background: #eef2ff;
      transform: scale(1.02);
    }

    .file-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-content {
      pointer-events: none;
    }

    .upload-icon {
      font-size: 2rem;
      color: #64748b;
      margin-bottom: 8px;
    }

    .upload-text {
      color: #64748b;
      font-weight: 500;
    }

    .selected-file {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      display: none;
    }

    .selected-file.show {
      display: block;
    }

    .file-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .file-details {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .file-icon {
      width: 40px;
      height: 40px;
      background: #eef2ff;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #4f46e5;
    }

    .file-meta {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }

    .file-size {
      color: #64748b;
      font-size: 0.8rem;
    }

    .remove-file {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .remove-file:hover {
      background: #fecaca;
    }

    #uploadStatus {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      display: none;
      text-align: center;
      font-weight: 500;
    }

    .success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .error {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .loading {
      background: #dbeafe;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .typing-indicator {
      display: none;
      padding: 12px 20px;
      color: #64748b;
      font-style: italic;
      font-size: 0.9rem;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        height: auto;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
      }

      .chat-controls {
        padding: 15px;
      }

      .control-button {
        padding: 10px;
        font-size: 0.85rem;
      }

      .message-input-container {
        flex-direction: column;
        gap: 8px;
      }

      .send-button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>💬 Personal Chat room of Soham</h1>
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
      </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <div class="user-section">
          <div class="user-input-group">
            <label for="usernameInput">👤 Your Username</label>
            <input type="text" id="usernameInput" class="username-input" placeholder="Enter your username" maxlength="20" />
            <div class="username-status" id="usernameStatus">✓ Username set</div>
          </div>
        </div>

        <div class="chat-controls">
          <button class="control-button btn-primary" onclick="loadAllChats()" id="loadChatsBtn">
            📚 Load Chat History
          </button>
          
          <button class="control-button btn-secondary" onclick="clearMessages()" id="clearBtn" disabled>
            🗑️ Clear Messages
          </button>
          
          <button class="control-button btn-secondary" onclick="scrollToBottom()" id="scrollBtn">
            ⬇️ Scroll to Bottom
          </button>
        </div>
      </div>

      <div class="chat-area">
        <div id="messages">
          <div class="empty-state">
            <div class="empty-icon">💬</div>
            <h3>Welcome to Personal Chat room of Soham!</h3>
            <p>Enter your username and start chatting with others.</p>
          </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
          🔵 Someone is typing...
        </div>

        <div class="input-area">
          <div class="message-input-container">
            <input type="text" id="messageInput" class="message-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)" disabled />
            <button onclick="sendMessage()" class="send-button" id="sendBtn" disabled>Send</button>
          </div>

          <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="file-input" accept="image/*,application/pdf,.txt,.doc,.docx" onchange="handleFileSelect(this)" />
            <div class="upload-content">
              <div class="upload-icon">📎</div>
              <div class="upload-text">Click or drag files to upload</div>
            </div>
          </div>

          <div class="selected-file" id="selectedFile">
            <div class="file-info">
              <div class="file-details">
                <div class="file-icon" id="fileIcon">📄</div>
                <div class="file-meta">
                  <div class="file-name" id="fileName"></div>
                  <div class="file-size" id="fileSize"></div>
                </div>
              </div>
              <button class="remove-file" onclick="clearFileSelection()" title="Remove file">✕</button>
            </div>
          </div>

          <div id="uploadStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket;
    let isConnected = false;
    let currentUsername = '';
    let selectedFile = null;

    // Initialize the app
    function init() {
      connectWebSocket();
      setupEventListeners();
      setupDragAndDrop();
    }

    function connectWebSocket() {
      socket = new WebSocket("wss://zs1f4aebc3.execute-api.ap-south-1.amazonaws.com/dev");
      
      socket.onopen = () => {
        console.log("Connected to chat");
        isConnected = true;
        updateConnectionStatus(true);
      };

      socket.onclose = () => {
        console.log("Disconnected from chat");
        isConnected = false;
        updateConnectionStatus(false);
        // Attempt to reconnect after 3 seconds
        setTimeout(connectWebSocket, 3000);
      };

      socket.onerror = (error) => {
        console.error("WebSocket error:", error);
        updateConnectionStatus(false);
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.action === "message") {
          displayMessage(data.username, data.message, data.fileUrl, data.timestamp);
        } else {
          displayMessage("System", event.data);
        }
      };
    }

    function setupEventListeners() {
      const usernameInput = document.getElementById("usernameInput");
      const messageInput = document.getElementById("messageInput");

      usernameInput.addEventListener('input', handleUsernameChange);
      messageInput.addEventListener('input', handleMessageInput);
    }

    function setupDragAndDrop() {
      const uploadArea = document.querySelector('.file-upload-area');

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect({ files: files });
        }
      });
    }

    function handleUsernameChange() {
      const usernameInput = document.getElementById("usernameInput");
      const usernameStatus = document.getElementById("usernameStatus");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      
      currentUsername = usernameInput.value.trim();
      
      if (currentUsername.length >= 3) {
        usernameStatus.classList.add('valid');
        messageInput.disabled = false;
        sendBtn.disabled = false;
        messageInput.placeholder = "Type your message...";
      } else {
        usernameStatus.classList.remove('valid');
        messageInput.disabled = true;
        sendBtn.disabled = true;
        messageInput.placeholder = "Enter a username first...";
      }
    }

    function handleMessageInput() {
      // Could add typing indicators here
    }

    function updateConnectionStatus(connected) {
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      
      if (connected) {
        statusDot.classList.add('connected');
        statusText.textContent = "Connected";
      } else {
        statusDot.classList.remove('connected');
        statusText.textContent = "Disconnected";
      }
    }

    function displayMessage(username, message, fileUrl = null, timestamp = null) {
      const messagesDiv = document.getElementById("messages");
      
      // Remove empty state if it exists
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      const msgDiv = document.createElement("div");
      msgDiv.className = "message";
      
      const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
      
      let fileContent = '';
      if (fileUrl) {
        const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(fileUrl);
        if (isImage) {
          fileContent = `
            <div class="message-file">
              <img src="${fileUrl}" alt="Shared image" onclick="window.open('${fileUrl}', '_blank')" 
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
              <div style="display:none;">
                <a href="${fileUrl}" target="_blank" class="file-link">
                  🖼️ View Image
                </a>
              </div>
            </div>
          `;
        } else {
          fileContent = `
            <div class="message-file">
              <a href="${fileUrl}" target="_blank" class="file-link">
                📎 ${message.includes('shared a file:') ? message.split('shared a file: ')[1] : 'View File'}
              </a>
            </div>
          `;
        }
      }
      
      msgDiv.innerHTML = `
        <div class="message-bubble">
          <div class="message-header">
            <span class="message-username">${username}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-content">${message}</div>
          ${fileContent}
        </div>
      `;
      
      messagesDiv.appendChild(msgDiv);
      scrollToBottom();
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function sendMessage() {
      const messageInput = document.getElementById("messageInput");
      const message = messageInput.value.trim();

      if (!currentUsername) {
        showStatus("Please enter your username first", "error");
        document.getElementById("usernameInput").focus();
        return;
      }
      
      if (!message && !selectedFile) {
        showStatus("Please enter a message or select a file", "error");
        messageInput.focus();
        return;
      }

      if (!isConnected) {
        showStatus("Not connected to chat. Please wait...", "error");
        return;
      }

      // If there's a selected file, upload it first
      if (selectedFile) {
        uploadFile();
        return;
      }

      // Send text message
      socket.send(JSON.stringify({ 
        action: "sendMessage", 
        username: currentUsername, 
        message 
      }));
      
      messageInput.value = "";
    }

    function handleFileSelect(input) {
      const file = input.files[0];
      if (!file) return;

      // Validate file size (10MB limit)
      if (file.size > 10 * 1024 * 1024) {
        showStatus("File size must be less than 10MB", "error");
        return;
      }

      selectedFile = file;
      showSelectedFile(file);
    }

    function showSelectedFile(file) {
      const selectedFileDiv = document.getElementById("selectedFile");
      const fileName = document.getElementById("fileName");
      const fileSize = document.getElementById("fileSize");
      const fileIcon = document.getElementById("fileIcon");

      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      
      // Set appropriate icon based on file type
      if (file.type.startsWith('image/')) fileIcon.textContent = '🖼️';
      else if (file.type === 'application/pdf') fileIcon.textContent = '📄';
      else if (file.type.includes('text')) fileIcon.textContent = '📝';
      else fileIcon.textContent = '📎';

      selectedFileDiv.classList.add('show');
    }

    function clearFileSelection() {
      selectedFile = null;
      document.getElementById("fileInput").value = "";
      document.getElementById("selectedFile").classList.remove('show');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function uploadFile() {
      if (!selectedFile) {
        showStatus("Please select a file", "error");
        return;
      }

      if (!currentUsername) {
        showStatus("Please enter your username first", "error");
        return;
      }

      const sendBtn = document.getElementById("sendBtn");
      sendBtn.disabled = true;
      sendBtn.textContent = "Uploading...";
      showStatus("Uploading file...", "loading");

      const formData = new FormData();
      formData.append("file", selectedFile);

      fetch("https://rjpc3o7tl3.execute-api.ap-south-1.amazonaws.com/dev/upload", {
        method: "POST",
        body: formData,
      })
      .then(async (res) => {
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || `HTTP ${res.status}`);
        }
        return data;
      })
      .then((data) => {
        showStatus("File uploaded successfully!", "success");
        
        // Get the message text if any
        const messageInput = document.getElementById("messageInput");
        const messageText = messageInput.value.trim() || `shared a file: ${selectedFile.name}`;
        
        // Send the message with file URL
        socket.send(JSON.stringify({ 
          action: "sendMessage", 
          username: currentUsername, 
          message: messageText,
          fileUrl: data.url
        }));
        
        // Clear inputs
        messageInput.value = "";
        clearFileSelection();
      })
      .catch((err) => {
        console.error("Upload error:", err);
        showStatus(`Upload failed: ${err.message}`, "error");
      })
      .finally(() => {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send";
      });
    }

    async function loadAllChats() {
      const loadBtn = document.getElementById("loadChatsBtn");
      loadBtn.disabled = true;
      loadBtn.textContent = "Loading...";
      
      try {
        showStatus("Loading chat history...", "loading");
        
        // You'll need to create this endpoint in your backend
        const response = await fetch("https://rjpc3o7tl3.execute-api.ap-south-1.amazonaws.com/dev/messages");
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Clear current messages
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";
        
        // Display historical messages
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => {
            displayMessage(msg.username, msg.message, msg.fileUrl, msg.timestamp);
          });
          showStatus(`Loaded ${data.messages.length} messages`, "success");
        } else {
          messagesDiv.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">📭</div>
              <h3>No messages found</h3>
              <p>Start a conversation to see messages here.</p>
            </div>
          `;
          showStatus("No messages found", "error");
        }
        
      } catch (error) {
        console.error("Error loading chats:", error);
        showStatus("Failed to load chat history", "error");
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = "📚 Load Chat History";
      }
    }

    function clearMessages() {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">🧹</div>
          <h3>Messages Cleared</h3>
          <p>The chat has been cleared locally.</p>
        </div>
      `;
      showStatus("Messages cleared", "success");
    }

    function scrollToBottom() {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById("uploadStatus");
      statusDiv.textContent = message;
      statusDiv.className = type;
      statusDiv.style.display = "block";
      
      // Auto-hide after 3 seconds for success/error, keep loading visible
      if (type !== 'loading') {
        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      }
    }

    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
